{% extends 'layout.html' %}
{% block title %}Saisir Score{% endblock %}
{% block content %}
<h1 class="mb-3">Saisir Score pour {{ tour.name }}</h1>
<form method="post">
    {{ csrf_token() }}
    <div class="mb-3">
        <label class="form-label">Handicap de jeu
            <input type="number" name="handicap" id="handicap" value="{{ score.handicap if score else '' }}" class="form-control" required>
        </label>
    </div>
    <div class="mb-3">
        <label class="form-label"><span title="Ajustement des conditions de jeu automatique calculé par la FFGolf, valeur entre -1 et +3.">PCC</span>
            <input type="number" name="pcc" step="1" min="-1" max="3" value="{{ tour.get('pcc', 0) }}" class="form-control" required>
        </label>
    </div>
    {% if score %}
    <input type="hidden" name="id" value="{{ score.doc_id }}">
    {% endif %}
    <table class="table table-bordered">
        <thead>
            <tr>
                <th></th>
                {% for i in range(1, 19) %}
                <th>{{ i }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <tr>
                <th>Par</th>
                {% for i in range(1, 19) %}
                <td><input type="number" name="par_{{ i }}" id="par_{{ i }}" step="1" value="{{ score.holes[i-1].par if score else tour.pars[i-1] }}" class="form-control" required></td>
                {% endfor %}
            </tr>
            <tr>
                <th>HCP</th>
                {% for i in range(1, 19) %}
                <td><input type="number" name="hcp_{{ i }}" id="hcp_{{ i }}" step="1" value="{{ tour.hcps[i-1] }}" class="form-control" readonly></td>
                {% endfor %}
            </tr>
            <tr>
                <th>Coups reçus</th>
                {% for i in range(1, 19) %}
                <td><input type="number" name="given_{{ i }}" id="given_{{ i }}" step="1" value="{{ score.holes[i-1].strokes_given if score else '' }}" class="form-control" readonly></td>
                {% endfor %}
            </tr>
            <tr>
                <th>Score</th>
                {% for i in range(1, 19) %}
                <td><input type="number" name="strokes_{{ i }}" id="strokes_{{ i }}" step="1" value="{{ score.holes[i-1].strokes if score else '' }}" class="form-control" required></td>
                {% endfor %}
            </tr>
            <tr>
                <th>Score brut ajusté</th>
                {% for i in range(1, 19) %}
                <td><input type="number" name="adjusted_{{ i }}" id="adjusted_{{ i }}" value="{{ score.holes[i-1].adjusted if score else '' }}" class="form-control" {% if not score %}readonly{% endif %}></td>
                {% endfor %}
            </tr>
            <tr>
                <th>Fairway touché</th>
                {% for i in range(1, 19) %}
                <td class="text-center"><input type="checkbox" id="fairway_{{ i }}" name="fairway_{{ i }}" class="form-check-input" {% if score and score.holes[i-1].fairway %}checked{% endif %}></td>
                {% endfor %}
            </tr>
            <tr>
                <th>Green en régulation</th>
                {% for i in range(1, 19) %}
                <td class="text-center"><input type="checkbox" name="gir_{{ i }}" id="gir_{{ i }}" class="form-check-input" {% if score and score.holes[i-1].gir %}checked{% endif %}></td>
                {% endfor %}
            </tr>
            <tr>
                <th>Nb de Putts</th>
                {% for i in range(1, 19) %}
                <td><input type="number" name="putts_{{ i }}" id="putts_{{ i }}" step="1" value="{{ score.holes[i-1].putts if score else '' }}" class="form-control" required></td>
                {% endfor %}
            </tr>
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary">Enregistrer</button>
</form>
{% endblock %}
<script>
function updateFairway(i){
    var parInput = document.getElementById('par_' + i);
    var fairway = document.getElementById('fairway_' + i);
    if(parInput && fairway){
        if(parseInt(parInput.value) <= 3){
            fairway.checked = false;
            fairway.disabled = true;
        } else {
            fairway.disabled = false;
        }
    }
}

function computeAdjusted(i){
    var par = parseInt(document.getElementById('par_' + i).value) || 0;
    var given = parseInt(document.getElementById('given_' + i).value) || 0;
    var strokes = parseInt(document.getElementById('strokes_' + i).value) || 0;
    var limit = par + 2 + given;
    var adjusted = Math.min(strokes, limit);
    var field = document.getElementById('adjusted_' + i);
    if(field){
        field.value = adjusted;
    }
}

function computeGiven(){
    var handicap = parseInt(document.getElementById('handicap').value) || 0;
    var base = Math.floor(handicap / 18);
    var extra = handicap % 18;
    for(var i=1; i<=18; i++){
        var hcp = parseInt(document.getElementById('hcp_' + i).value) || i;
        var val = base + (hcp <= extra ? 1 : 0);
        var field = document.getElementById('given_' + i);
        if(field){
            field.value = val;
        }
    }
}

document.addEventListener('DOMContentLoaded', function(){
    computeGiven();
    for(var i = 1; i <= 18; i++){
        updateFairway(i);
        computeAdjusted(i);
        ['par_', 'strokes_'].forEach(function(prefix){
            var el = document.getElementById(prefix + i);
            if(el){
                el.addEventListener('input', function(){
                    updateFairway(i);
                    computeAdjusted(i);
                });
            }
        });
    }
    var handicapField = document.getElementById('handicap');
    if(handicapField){
        handicapField.addEventListener('input', function(){
            computeGiven();
            for(var i=1; i<=18; i++){ computeAdjusted(i); }
        });
    }
});
</script>
