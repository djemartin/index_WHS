{% extends 'layout.html' %}
{% if tour %}{% set page_title = 'Modifier le Tour' %}{% else %}{% set page_title = 'Ajouter un Tour' %}{% endif %}
{% block title %}{{ page_title }}{% endblock %}
{% block content %}
<h1 class="mb-3">{{ page_title }}</h1>
<form method="post">
    {{ csrf_token() }}
    {% if tour %}
    <input type="hidden" name="id" value="{{ tour.doc_id }}">
    {% endif %}
    <div class="mb-3">
        <label class="form-label">Nom du Tour
            <input type="text" name="name" value="{{ tour.name if tour else '' }}" class="form-control" required>
        </label>
    </div>
    <div class="mb-3">
        <label class="form-label">Jour
            <input type="number" name="jour" step="1" value="{{ tour.jour if tour else '' }}" class="form-control" required>
        </label>
    </div>
    <div class="mb-3">
        <label class="form-label">Date
            <input type="date" name="date" value="{{ tour.date if tour else '' }}" class="form-control" required>
        </label>
    </div>
    <div class="mb-3">
        <label class="form-label">Golf joué
            <select name="golf" id="golf_select" class="form-select" required>
                <option value="">--Choisir--</option>
                {% for g in golfs %}
                <option value="{{ g.doc_id }}" {% if tour and tour.golf_id == g.doc_id %}selected{% endif %}>{{ g.name }}</option>
                {% endfor %}
            </select>
            <a href="/golf" class="btn btn-sm btn-secondary ms-2">+</a>
        </label>
    </div>
    <div class="mb-3">
        <label class="form-label">Par du parcours
            <input type="number" name="par" step="1" value="{{ tour.par if tour else '' }}" class="form-control" required>
        </label>
    </div>
    <div class="mb-3">
        <label class="form-label">Slope
            <input type="number" name="slope" step="1" value="{{ tour.slope if tour else '' }}" class="form-control" required>
        </label>
    </div>
    <div class="mb-3">
        <label class="form-label">SSS
            <input type="number" name="sss" step="0.1" value="{{ tour.sss if tour else '' }}" class="form-control" required>
        </label>
    </div>
    <div class="mb-3">
        <label class="form-label"><span title="Ajustement des conditions de jeu automatique calculé par la FFGolf, valeur entre -1 et +3.">PCC</span>
            <input type="number" name="pcc" step="1" min="-1" max="3" value="{{ tour.pcc if tour else 0 }}" class="form-control" required>
        </label>
    </div>
    <h2>Par et HCP par trou</h2>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Trou</th>
                <th>Par</th>
                <th>HCP</th>
            </tr>
        </thead>
        <tbody>
            {% for i in range(1, 19) %}
            <tr>
                <td>{{ i }}</td>
                <td><input type="number" name="par_{{ i }}" step="1" value="{{ tour.pars[i-1] if tour and tour.pars else '' }}" class="form-control" required></td>
                <td><input type="number" name="hcp_{{ i }}" step="1" value="{{ tour.hcps[i-1] if tour and tour.hcps else i }}" class="form-control" required></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary">Enregistrer</button>
    {% if tour %}
    <a href="{{ url_for('add_tour') }}" class="btn btn-secondary ms-2">Annuler</a>
    {% endif %}
</form>
{% endblock %}
<script>
    const golfData = {{ golfs_json|tojson }};
    function updateGolfInfo(id){
        const g = golfData.find(x => x.doc_id == id);
        if(!g) return;
        document.querySelector('input[name="par"]').value = g.par;
        document.querySelector('input[name="slope"]').value = g.slope;
        document.querySelector('input[name="sss"]').value = g.sss;
        if(g.pars){
            for(let i=1; i<=18; i++){
                const field = document.querySelector(`input[name="par_${i}"]`);
                if(field){
                    field.value = g.pars[i-1];
                }
            }
        }
        if(g.hcps){
            for(let i=1; i<=18; i++){
                const field = document.querySelector(`input[name="hcp_${i}"]`);
                if(field){
                    field.value = g.hcps[i-1];
                }
            }
        }
    }
    document.addEventListener('DOMContentLoaded', function(){
        const select = document.getElementById('golf_select');
        if(select){
            select.addEventListener('change', function(){
                updateGolfInfo(parseInt(this.value));
            });
            if(select.value){
                updateGolfInfo(parseInt(select.value));
            }
        }
    });
</script>
